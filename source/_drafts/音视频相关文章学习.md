---
title: 直播相关文章学习
tags:
---

## 直播服务流程简述

摘自：https://juejin.im/post/5e48d999e51d452703135d11

### 发送端

- 1.主播通过设备的麦克风采集原始音频数据（pcm格式），摄像头采集原始视频数据（yuv格式）
- 2.通过编解码工具（如MediaCodec-硬编，ffmpeg-软编）将原始音频、视频数据分别转换成aac和h264格式
- 3.通过混合器提取音视频数据中的轨道并封装成flv格式
- 4.将flv数据包裹上rtmp协议头并将数据发送到服务器

### 接收端

- 1.观众通过客户端设备进入房间，`播放器`通过rtmp协议向服务器拉取视频数据流
- 2.用rtmp协议解析数据流，得到flv格式的数据流
- 3.`播放器`将flv格式数据解析成音视频数据流（aac，h264）
- 4.通过编解码工具将aac和h264解码成原始的音视频数据
- 5.调用设备的扬声器播放音频数据，显卡渲染视频数据并在屏幕上显示



## 硬编码之MediaCodec

摘自：https://www.jianshu.com/p/f116b6f81ab3

码率或码流率，通俗一点的理解就是取样率,是视频编码中画面质量控制中最重要的部分，一般我们用的单位是kb/s或者Mb/s。

编码又分为硬编码和软编码

整个视频直播分为以下几个步骤：
采集—>处理—>编码和封装—>推流到服务器—>服务器流分发—>播放器流播放

如果把整个流媒体比喻成一个物流系统，那么编解码就是其中配货和装货的过程，这个过程非常重要，它的速度和压缩比对物流系统的意义非常大，影响物流系统的整体速度和成本。

为什么巨大的原始视频可以编码成很小的视频呢?这其中的技术是什么呢?`核心思想就是去除冗余信息`

1. 空间冗余：图像相邻像素之间有较强的相关性
2. 时间冗余：视频序列的相邻图像之间内容相似
3. 编码冗余：不同像素值出现的概率不同
4. 视觉冗余：人的视觉系统对某些细节不敏感
5. 知识冗余：规律性的结构可由先验知识和背景知识得到

#### 编码标准的选择

经过数十年的发展，从开始的只支持帧内编码演进到现如今的H.265和VP9为代表的新一代编码标准，下面是一些常见的视频编码标准：

1. H.264/AVC
2. HEVC/H.265
3. VP8
4. VP9
5. FFmpeg
6. ...

下面是一些常见的音频编码标准

1. MP3
2. AAC
3. WMA
4. PCM
5. ...

#### 封装

封装就是媒体的容器，而容器就是把编码器生成的多媒体内容(视频，音频，字幕，章节信息等)混合封装在一起的标准。容器使得不同多媒体内容同步播放变得很简单，而容器的另一个作用就是为多媒体内容提供索引，也就是说如果没有容器存在的话一部影片你只能从一开始看到最后，不能拖动进度条，而且打开的视频也没有声音。下面是几种常见的封装格式：

1. AVI 格式(后缀为 .avi)
2. DV-AVI 格式(后缀为 .avi)
3. QuickTime File Format 格式(后缀为 .mov)
4. MPEG 格式(文件后缀可以是 .mpg .mpeg .mpe .dat .vob .asf .3gp .mp4等)
5. WMV 格式(后缀为.wmv .asf)
6. Real Video 格式(后缀为 .rm .rmvb)
7. Flash Video 格式(后缀为 .flv)
8. Matroska 格式(后缀为 .mkv)
9. MPEG2-TS 格式 (后缀为 .ts)

目前，我们在流媒体传输，尤其是直播中主要采用的就是 `FLV 和 MPEG2-TS` 格式，分别用于 `RTMP/HTTP-FLV 和 HLS `协议。

#### 硬件编码

在Android 4.1 之前，Android是没有提供硬件编码的API，所以之前都是采用FFMPEG来进行软编码的，而FFMPEG都是用C语言开发的，对于阅读源码及学习都有一定的门槛。对于同一平台，同一硬件环境，硬件编码速度快于软件编码，CPU占有率更低，所以**能用硬件编码的条件下，我们尽量用硬件编码。**

MediaCodec类可用于访问Android底层的多媒体编解码器，例如，编码器/解码器组件。

MediaCodec采用`异步方式`处理数据，并且使用了一组输入输出缓存（input and output buffers）。简单来讲，**你请求或接收到一个空的输入缓存（input buffer），向其中填充满数据并将它传递给编解码器处理。编解码器处理完这些数据并将处理结果输出至一个空的输出缓存（output buffer）中。最终，你请求或接收到一个填充了结果数据的输出缓存（output buffer），使用完其中的数据，并将其释放给编解码器再次使用。**



## 声音的模拟数字转换

摘自：https://juejin.im/post/5e48fed7f265da57503cbd37

声波从模拟信号转化为数字信号，要经过采样、量化、编码三个步骤。

+ 采样

  人耳只能听到频率**20Hz～20kHz**的声音，根据耐奎斯特采样理论，**采样频率必须是信号最高频率的两倍，这样才能保证质量不失真**，所以采样率一般为44.1kHz，即每秒采样44100个点，这样能保证每个声波至少有两个采样点。

+ 量化

  量化是指在幅度轴上对信号离散化，一般用16bit或8bit来表示声音的一个采样，以16bit为例，取值范围为[-32768，32767]，因此在幅度轴上分了65536层。

+ 编码

  编码就是按照一定的格式记录采样和量化后的数字数据，比如顺序存储（PCM）或压缩存储（AAC、MP3）等等。



## 傅里叶变化

B栈视频：https://www.bilibili.com/video/av51932171/

![img](http://47.110.40.63:8080/img/blog/傅里叶变换.png)



## 熵编码

摘自：https://juejin.im/post/5e64a691e51d452716051448

**在能量转换过程中浪费掉的、无法再利用的能量称为熵**。

宇宙中所有物体都在运动，因此能量最终都会转变成熵，即**宇宙万物都处在一种有序趋向无序的状态中**。

信息熵是香农参考热力学熵提出的，`它代表观察者对某一事件（结果）的未知程度`。熵与信息的概念是相对的，**信息量度量的是一个具体事件发生了所带来的信息，而熵则是在结果出来之前对可能产生的信息量的期望**。获取信息意味着消除不确定性，也就是消除熵，他们的数量是相等的。

`信息熵是编码这个信源平均所需要的最小位数`。比如抛三枚硬币，正反的概率都是1/2，那么三枚硬币依次是“正反反”这个事件的信息熵为log(8) = 3，即至少需要3个bit来表示，如100（1代表正面，0代表反面）。

香农提出了信源编码定理。该定理说明了香农熵与信源符号概率之间的关系，说明信息的熵为信源无损编码后的平均码字长度的下限。`任何的无损编码方法都不可能使编码后的平均码长小于香农熵，只能使其尽量接近`。

常见的熵编码有：哈夫曼编码、算数编码、游程编码

